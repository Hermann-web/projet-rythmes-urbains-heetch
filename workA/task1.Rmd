---
title: "task1"
output: html_document
date: "`r Sys.Date()`"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Introduction

## Load packages
```{r LoadPackages}
library(dplyr) 
library(sf)
library(leaflet)
library(lubridate)
library(mapsf)
library(tidyr)
```
## Load data and project spatial features
```{r LoadData}
heetchPoints <-readRDS("../data/heetchmarchcropwithneib.Rds")
casaNeib <-st_read("../data/casaneib.geojson") 
casaNeibProj <-st_transform(casaNeib, crs=26191)
heetchPointsProj <-st_transform(heetchPoints, crs=26191)
rm(heetchPoints)
rm(casaNeib)
#heetch_points_proj
head(heetchPointsProj) #(driver_id, location_at_local_time, geometry)
class(heetchPointsProj)
str(heetchPointsProj)

#heetch_points_proj
head(casaNeibProj) #(driver_id, location_at_local_time, geometry)
class(casaNeibProj)
str(casaNeibProj)
```

# Pour chaque heure, combien de drivers

## Créer la section du 1er Mars

```{r subsetmarch01}
heetchPointsProj$Day <-day(heetchPointsProj$location_at_local_time)
heetchPointsProj$Hour <-hour(heetchPointsProj$location_at_local_time)
heetchM1Proj <-heetchPointsProj %>% 
  filter(Day==1) 
  # %>% filter(Hour>22 | Hour<7 )
head(heetchM1Proj) #(driver_id, location_at_local_time, geometry, NEIB, Day, Hour)
str(heetchM1Proj)
nrow(heetchM1Proj) #166259
```

## Grouper par heure/ par identifiant chauffeur et par quartier

```{r nestedPts}
nestedPts <-heetchM1Proj %>% 
  st_drop_geometry() %>% 
  group_by(Hour, NEIB, driver_id) %>% 
  summarize(NBPTS=n())
nrow(nestedPts) #5032
head(nestedPts) #Hour,driver_id,NEIB,NBPTS
class(nestedPts)
```

## Selectionner le quartier principal pour chaque chauffeur à chaque heure

```{r mainNeib}
mainNeib <-nestedPts %>% 
  group_by(driver_id, Hour) %>% 
  arrange(desc(NBPTS)) %>% 
  slice(1)
nrow(mainNeib) #1374
class(mainNeib) #Hour,driver_id,NEIB,NBPTS
head(mainNeib)
```
## Pour chaque heure, calculer le nombre de chauffeurs

```{r NbDriverPerHour}
NbDriverPerHour <-nestedPts %>% 
  group_by(Hour) %>% 
  summarize(NBDRiver=n())
nrow(NbDriverPerHour) #8
class(NbDriverPerHour) #Hour,NBDRiver
head(NbDriverPerHour)
```

## Pour chaque heure, pour chaque quartier, calculer le nombre de chauffeurs

```{r mainNeibN}
mainNeibN <-nestedPts %>% 
  group_by(Hour, NEIB) %>% 
  summarize(NBDRiver=n())
nrow(mainNeibN) #198
class(mainNeibN) #Hour,NBDRiver,NEIB
head(mainNeibN)
```

## Trouver les heures de pointes
```{r PeakHours}
PeakHours <-mainNeibN %>% 
  filter(NBDRiver>30) %>% 
  select(Hour, NEIB) %>%
  group_by(Hour) %>% 
  summarize(NBNEIB=n())
nrow(PeakHours) #198
class(PeakHours) #Hour,NBNEIB
head(PeakHours)
```
## Trouver les heures de pointes
```{r PeakHuours}
# 8. Construire la matrice OD (origine-destination) pour le 1er Mars entre 7H et 8H du matin
# mainNeibwide a comme colonne(driver_id, hours:00,01...)
mainNeibwide <-mainNeib %>% 
  select(driver_id,Hour,NEIB) %>% 
  pivot_wider(names_from=Hour, 
              values_from=NEIB,
              names_prefix="H",
              values_fill=NA)

OD78 <-mainNeibwide %>% 
  group_by(H7,H8) %>% 
  summarize(NB=n()) %>% 
  filter(!is.na(H7) & !is.na(H8))%>% 
  rename(ORI=H7, DES=H8)

OD78$ORINAME <-casaNeibProj$NAME_4[OD78$ORI]
OD78$DESNAME <-casaNeibProj$NAME_4[OD78$DES]

polCentroids <- st_centroid(casaNeibProj) # pour avoir les centroides
coordCentroids <-st_coordinates((polCentroids)) %>%as_data_frame()
# pour avoir les coordonnées des centroides
class(coordCentroids)

OD78$XORI <-coordCentroids$X[OD78$ORI]
OD78$XDES <-coordCentroids$X[OD78$DES]
OD78$YORI <-coordCentroids$Y[OD78$ORI]
OD78$YDES <-coordCentroids$Y[OD78$DES]

temp <- OD78$XORI

# Afficher la carte
selecFlows <-OD78 %>% filter(NB>2)
plot(casaNeibProj$geometry, col="grey80", border ="grey30")
arrows(selecFlows$XORI,
       selecFlows$YORI,
       selecFlows$XDES,
       selecFlows$YDES,
       col="chocolate",
       lwd=2,
       length=0.1,
       code=2)

```
